{
  "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUserName": {
      "type": "string",
      "defaultValue": "azureSample",
      "metadata": {
        "description": "User name for the Virtual Machine."
      }
    },
    "sshKeyData": {
      "type": "string",
      "metadata": {
        "description": "SSH rsa public key file as a string."
      }
    },
    "dnsLabelPrefix": {
      "type": "string",
      "metadata": {
        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D2",
      "metadata": {
        "description": "Size of the VM"
      }
    },
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "Name of the VM"
      }
    },
    "imagePublisher": {
      "type": "string",
      "defaultValue": "canonical",
      "metadata": {
        "description": "Name of the image publisher"
      }
    },
    "imageOffer": {
      "type": "string",
      "defaultValue": "ubuntuserver",
      "metadata": {
        "description": "Name of the image offer"
      }
    },
    "imageSku": {
      "type": "string",
      "defaultValue": "16.04.0-LTS",
      "metadata": {
        "description": "Name of the image sku"
      }
    },
    "imageVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Name of the image sku"
      }
    },
    "subnetName": {
      "type": "string",
      "defaultValue": "azsample-subnet",
      "metadata": {
        "description": "Name of the subnet"
      }
    },
    "virtualNetworkName": {
      "type": "string",
      "defaultValue": "azsampleVNET",
      "metadata": {
        "description": "Name of the virtual network"
      }
    }
  },
  "variables": {
    "storageAccountName": "[concat(uniquestring(resourceGroup().id), 'azsample')]",
    "location": "[resourceGroup().location]",
    "osDiskName": "osDisk1",
    "addressPrefix": "10.0.0.0/16",
    "subnetPrefix": "10.0.0.0/24",
    "vmStorageAccountContainerName": "azsample-vhds",
    "nicName": "[concat(parameters('vmName'), '-azsampleNIC')]",
    "publicIPAddressName": "[concat(parameters('vmName'), '-azsamplePublicIP')]",
    "publicIPAddressType": "Dynamic",
    "storageAccountType": "Standard_LRS",
    "networkSecurityGroupName": "[concat(parameters('vmName'), '-azsampleNSG')]",
    "sshKeyPath": "[concat('/home/',parameters('adminUsername'),'/.ssh/authorized_keys')]",
    "vnetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetName'))]",
    "apiVersion": "2015-06-15"
  },
  "resources": [
    {
      "name": "deployControllers",
      "condition": "[equals(parameters('deployDCs'),'true')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://github.com/insidepowershell/resource-manager-ruby-template-deployment/blob/master/templates/dc.json",
          "contentVersion": "1.0.0.0"
        },
        "parametersLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('TemplateFolder'),'/', substring(parameters('environment'),0,3), '/', variables('TemplateParametersFileName'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      }
    },
    {
      "name": "deployNetworking",
      "condition": "[equals(parameters('deployNetworking'),'true')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://github.com/insidepowershell/resource-manager-ruby-template-deployment/blob/master/templates/Networking.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "tagSettings": {
            "value": "[variables('tagSettings2')]"
          },
          "networkSettings": {
            "value": "[variables('networkSettings')]"
          }
        }
      }
    },
    {
      "name": "deployWebResources",
      "condition": "[equals(parameters('deployWebResources'),'true')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://github.com/insidepowershell/resource-manager-ruby-template-deployment/blob/master/templates/webresources.json",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "tagSettings": {
            "value": "[variables('tagSettings2')]"
          },
          "networkSettings": {
            "value": "[variables('networkSettings')]"
          }
        }
      }
    }
  ]
}